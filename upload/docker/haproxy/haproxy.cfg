global
    daemon
    maxconn 4096
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog
    log global

# HAProxy Statistics
stats socket /var/run/haproxy.sock mode 600 level admin
stats timeout 2m

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats admin if TRUE

# Frontend for PostgreSQL write operations
frontend postgres_frontend
    bind *:5432
    default_backend postgres_write

# Backend for write operations (Master only)
backend postgres_write
    balance roundrobin
    option pgsql-check user upload_user
    server postgres-master postgres-master:5432 check

# Backend for read operations (Master + Slave)
backend postgres_read
    balance roundrobin
    option pgsql-check user upload_user
    server postgres-master postgres-master:5432 check weight 30
    server postgres-slave postgres-slave:5432 check weight 70

# Frontend for read operations (separate port)
frontend postgres_read_frontend
    bind *:5435
    default_backend postgres_read 